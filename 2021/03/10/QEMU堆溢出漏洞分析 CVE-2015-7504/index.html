<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"morningbread.github.io","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="环境搭建这个CVE的环境搭建可以模仿CVE-2015-5165的搭建过程。">
<meta property="og:type" content="article">
<meta property="og:title" content="QEMU堆溢出漏洞分析 CVE-2015-7504">
<meta property="og:url" content="https://morningbread.github.io/2021/03/10/QEMU%E5%A0%86%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%20CVE-2015-7504/index.html">
<meta property="og:site_name" content="coco&#39;s blog">
<meta property="og:description" content="环境搭建这个CVE的环境搭建可以模仿CVE-2015-5165的搭建过程。">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2021-03-10T07:24:05.000Z">
<meta property="article:modified_time" content="2021-04-07T02:51:12.382Z">
<meta property="article:author" content="coco">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://morningbread.github.io/2021/03/10/QEMU%E5%A0%86%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%20CVE-2015-7504/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>QEMU堆溢出漏洞分析 CVE-2015-7504 | coco's blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">
<!-- hexo injector head_end end --></head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">coco's blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://morningbread.github.io/2021/03/10/QEMU%E5%A0%86%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%20CVE-2015-7504/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="coco">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="coco's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          QEMU堆溢出漏洞分析 CVE-2015-7504
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-03-10 15:24:05" itemprop="dateCreated datePublished" datetime="2021-03-10T15:24:05+08:00">2021-03-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-04-07 10:51:12" itemprop="dateModified" datetime="2021-04-07T10:51:12+08:00">2021-04-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/qemu/" itemprop="url" rel="index"><span itemprop="name">qemu</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><p>这个CVE的环境搭建可以模仿CVE-2015-5165的搭建过程。</p>
<span id="more"></span>

<h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>CVE-2015-7504是qemu模拟pcnet网卡时发生了一个4字节的堆溢出，配合地址泄漏的相关漏洞可以达到虚拟机逃逸，执行宿主机代码的效果。漏洞发生在pcnet.c文件的pcnet_receive函数中，下面是漏洞的具体代码。这里的指针<code>p</code>指向的是pcnet中的一块buffer，大小为4096字节。这里主要是在计算buffer内容的CRC（4字节），最后把这个CRC放在内容结尾处，但是这里并没有校验到指针<code>p</code>的范围，导致最后4字节的CRC可能会发生越界写，覆盖掉后面的内容。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (s-&gt;looptest == PCNET_LOOPTEST_CRC ||</span><br><span class="line">         !CSR_DXMTFCS(s) || size &lt; MIN_BUF_SIZE+<span class="number">4</span>) &#123;</span><br><span class="line">  <span class="keyword">uint32_t</span> fcs = ~<span class="number">0</span>;</span><br><span class="line">  <span class="keyword">uint8_t</span> *p = src;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (p != &amp;src[size])</span><br><span class="line">    CRC(fcs, *p++);</span><br><span class="line">  *(<span class="keyword">uint32_t</span> *)p = htonl(fcs);</span><br><span class="line">  size += <span class="number">4</span>;</span><br></pre></td></tr></table></figure>

<p>我们来看一下可能会覆盖掉什么内容，通过对网卡结构体<code>PCNetState</code>的查看，可以知道buffer数组后面跟了一个指向<code>IRQState</code>结构体的指针。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">PCNetState_st</span> <span class="title">PCNetState</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">PCNetState_st</span> &#123;</span></span><br><span class="line">		...</span><br><span class="line">    <span class="keyword">uint8_t</span> buffer[<span class="number">4096</span>];</span><br><span class="line">    qemu_irq irq;</span><br><span class="line">		...</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">IRQState</span> *<span class="title">qemu_irq</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">IRQState</span> &#123;</span></span><br><span class="line">    Object parent_obj;</span><br><span class="line"></span><br><span class="line">    qemu_irq_handler handler;</span><br><span class="line">    <span class="keyword">void</span> *opaque;</span><br><span class="line">    <span class="keyword">int</span> n;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>通过CRC四字节的堆溢出可以部分修改<code>irq</code>指针，指向一个伪造的结构体。在<code>pcnet_receive</code>函数最后的地方，调用了一次<code>pcnet_update_irq(s)</code>，跟入这个函数，在这个函数的最后调用了一次<code>qemu_set_irq(s-&gt;irq, isr)</code>，这个函数定义为：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">qemu_set_irq</span><span class="params">(qemu_irq irq, <span class="keyword">int</span> level)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!irq)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    irq-&gt;handler(irq-&gt;opaque, irq-&gt;n, level);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在伪造的<code>IRQState</code>结构体中，如果设置<code>handler</code>为system@plt，opaque为command命令地址，就可以达到宿主机任意代码执行。</p>
<h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><h3 id="漏洞触发路径"><a href="#漏洞触发路径" class="headerlink" title="漏洞触发路径"></a>漏洞触发路径</h3><p>通过<code>lspci</code>查看网卡信息，看到PCnet网卡的id为00:05.0，通过<code>cat /proc/iomem</code>和<code>cat /proc/iomem</code>确认该网卡的mmio地址和pmio地址范围分别为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mmio：</span><br><span class="line">feb80000-febbffff : 0000:00:05.0</span><br><span class="line">pmio:</span><br><span class="line">c140-c15f : 0000:00:05.0</span><br></pre></td></tr></table></figure>

<p>接下来主要利用的是pmio的地址。</p>
<p>下面列出了漏洞触发链，对每个函数仅截取了关键的步骤。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">pcnet_ioport_write</span><span class="params">(<span class="keyword">void</span> *opaque, hwaddr addr,</span></span></span><br><span class="line"><span class="function"><span class="params">                               <span class="keyword">uint64_t</span> data, <span class="keyword">unsigned</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">...</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (size == <span class="number">2</span>) &#123;</span><br><span class="line">            pcnet_ioport_writew(d, addr, data);</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">pcnet_ioport_writew</span><span class="params">(<span class="keyword">void</span> *opaque, <span class="keyword">uint32_t</span> addr, <span class="keyword">uint32_t</span> val)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">...</span><br><span class="line">    <span class="keyword">if</span> (!BCR_DWIO(s)) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (addr &amp; <span class="number">0x0f</span>) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0x00</span>: <span class="comment">/* RDP */</span></span><br><span class="line">            pcnet_csr_writew(s, s-&gt;rap, val);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0x02</span>:</span><br><span class="line">            s-&gt;rap = val &amp; <span class="number">0x7f</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">pcnet_csr_writew</span><span class="params">(PCNetState *s, <span class="keyword">uint32_t</span> rap, <span class="keyword">uint32_t</span> new_value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">...</span><br><span class="line">    <span class="keyword">switch</span> (rap) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">...</span><br><span class="line">        <span class="keyword">if</span> (CSR_TDMD(s))</span><br><span class="line">            pcnet_transmit(s);</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">pcnet_transmit</span><span class="params">(PCNetState *s)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (CSR_LOOP(s)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (BCR_SWSTYLE(s) == <span class="number">1</span>)</span><br><span class="line">...</span><br><span class="line">            pcnet_receive(qemu_get_queue(s-&gt;nic), s-&gt;buffer, s-&gt;xmit_pos);</span><br><span class="line">            s-&gt;looptest = <span class="number">0</span>;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后就进入了漏洞函数<code>pcnet_receive</code>。</p>
<h3 id="CRC逆向"><a href="#CRC逆向" class="headerlink" title="CRC逆向"></a>CRC逆向</h3><p>由上面的分析我们已经知道，四字节的CRC可以覆盖irq的后四字节，所以只要我们能控制CRC的内容，我们就可以控制irq的地址。下面主要来介绍如何构造一个payload，以达到任意CRC写的目的。</p>
<p>先看一下怎么样正向去计算CRC，查看pcnet.c的源码可以知道，这里使用CRC这个宏去计算的，计算方法用的是查表法。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CRC(crc, ch)	 (crc = (crc &gt;&gt; 8) ^ crctab[(crc ^ (ch)) &amp; 0xff])</span></span><br></pre></td></tr></table></figure>

<p>举一个正向计算的例子，如果有一个四字节的CRC抽象成$A_1B_1C_1D_1$，其中每一个字母代表一个字节，CRC表项<code>crctab[(crc ^ (ch)) &amp; 0xff]</code>也抽象成 $E_1F_1G_1H_1$，新的CRC抽象成$A_2B_2C_2D_2$，根据这个计算公式可以得到$A_1B_1C_1 \ \ \ XOR \ \ \ E_1F_1G_1H_1 = A_2B_2C_2D_2$，进一步可以得到</p>
<p>$$ A_2 = E_1 $$</p>
<p>$$ B_2 = A_1 \ \ \ XOR \ \ \ F_1 $$</p>
<p>$$ C_2 = B_1 \ \ \ XOR \ \ \ G_1 $$</p>
<p>$$ D_2 = C_1 \ \ \ XOR \ \ \ H_1 $$</p>
<p>因此，$E_1$，即表项中的最高一个字节就是$A_2$，并且根据CRC表的特性可以知道，CRC表256项的最高一个字节是不重复的，所以可以推断出完整的表项内容$E_1F_1G_1H_1$以及表项的索引，$E_1F_1G_1H_1$已知之后，可以推出$A_1B_1C_1$。表项的索引已知后，因为$D_1 \ \ \ XOR \ \ \ ch = index$，所以$D_1 = ch \ \ \ XOR \ \ \ index$。这样就完成了一个正向计算的逆推。一次逆推，就是向前移动了一个字节，如果做四次逆推，就得到了一个原始CRC。并且这个原始CRC经过计算后可以得到目标CRC。</p>
<p>下面简单分析一下EXP中的相关过程：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">pcnet_packet_patch_crc</span><span class="params">(<span class="keyword">uint8_t</span> *packet, <span class="keyword">uint32_t</span> current,</span></span></span><br><span class="line"><span class="function"><span class="params">                            <span class="keyword">uint32_t</span> target)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">size_t</span> i = <span class="number">0</span>, j;</span><br><span class="line">	<span class="keyword">uint8_t</span> *ptr;</span><br><span class="line">	<span class="keyword">uint32_t</span> workspace[<span class="number">2</span>] = &#123; current, target &#125;;</span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i++)</span><br><span class="line">		workspace[i] &amp;= (<span class="keyword">uint32_t</span>)~<span class="number">0</span>;</span><br><span class="line">	ptr = (<span class="keyword">uint8_t</span> *)(workspace + <span class="number">1</span>);</span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) &#123;</span><br><span class="line">		j = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">while</span>(crctab[j] &gt;&gt; <span class="number">24</span> != *(ptr + <span class="number">3</span> - i)) j++;</span><br><span class="line">		*((<span class="keyword">uint32_t</span> *)(ptr - i)) ^= crctab[j];</span><br><span class="line">		*(ptr - i - <span class="number">1</span>) ^= j;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">strncpy</span>(packet, ptr - <span class="number">4</span>, <span class="number">4</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ptr = pcnet_packet;</span><br><span class="line"><span class="keyword">while</span> (ptr != &amp;pcnet_packet[PCNET_BUFFER_SIZE - <span class="number">4</span>])</span><br><span class="line">  CRC(fcs, *ptr++);</span><br><span class="line">pcnet_packet_patch_crc(ptr, fcs, htonl(<span class="number">0xdeadbeef</span>));</span><br></pre></td></tr></table></figure>

<p>一开始计算pcnet_packet前<code>PCNET_BUFFER_SIZE - 4</code>大小的CRC，目前四字节的CRC的存放在<code>fcs</code>中，<code>ptr=&amp;pcnet_packet[PCNET_BUFFER_SIZE - 4]</code>的。<code>pcnet_packet_patch_crc</code>函数是想模拟将<code>target</code>逆推后移4位，且之前的后4位是current。每次计算的过程如下图所示。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">                 D4  C4  B4  A4</span><br><span class="line">             D3  C3  B3  A3</span><br><span class="line">         D2  C2  B2  A2</span><br><span class="line">     D1  C1  B1  A1</span><br><span class="line">D0   C0  B0  A0</span><br><span class="line">|___|___|___|___|___|___|___|___|</span><br><span class="line">|----current----|----target-----|</span><br><span class="line">                &#x2F;\</span><br><span class="line">                ｜</span><br><span class="line">                ptr</span><br></pre></td></tr></table></figure>

<p>代码的步骤也可以参考之前的推导：</p>
<ol>
<li><code>while(crctab[j] &gt;&gt; 24 != *(ptr + 3 - i)) j++;</code>这段代码就是在找哪一个表项的最高一个字节能和$A_i$匹配上。</li>
<li><code>*((uint32_t *)(ptr - i)) ^= crctab[j];</code>这段代码就是在计算$A_{i-1}B_{i-1}C_{i-1}$，并考虑原来有的ch</li>
<li><code>*(ptr - i - 1) ^= j;</code>这段代码就是在计算$D_{i-1}$，并考虑原来有的ch</li>
</ol>
<h3 id="相关配置"><a href="#相关配置" class="headerlink" title="相关配置"></a>相关配置</h3><p>为了让程序走到漏洞代码上，要对网卡进行相关的配置。pcnet网卡的配置是通过初始化一个结构体<code>pcnet_config</code>，再将该结构体的物理地址传到网卡中（通过设置CSR[1]和CSR[2]）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pcnet_config</span> &#123;</span></span><br><span class="line">	<span class="keyword">uint16_t</span>  mode;</span><br><span class="line">	<span class="keyword">uint8_t</span>   rlen;</span><br><span class="line">	<span class="keyword">uint8_t</span>   tlen;</span><br><span class="line">	<span class="keyword">uint8_t</span>   mac[<span class="number">6</span>];</span><br><span class="line">	<span class="keyword">uint16_t</span> _reserved;</span><br><span class="line">	<span class="keyword">uint8_t</span>   ladr[<span class="number">8</span>];</span><br><span class="line">	<span class="keyword">uint32_t</span>  rx_desc;  <span class="comment">//接收描述符，传入pcnet_desc结构体的物理地址</span></span><br><span class="line">	<span class="keyword">uint32_t</span>  tx_desc;  <span class="comment">//发送描述符，传入pcnet_desc结构体的物理地址</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>pcnet_config</code>中有两个字段<code>rx_desc</code>和<code>tx_desc</code>，分别要初始化为接收和发送描述符。<code>pcnet_config</code>的结构如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pcnet_desc</span> &#123;</span></span><br><span class="line">	<span class="keyword">uint32_t</span>  addr;</span><br><span class="line">	<span class="keyword">int16_t</span>   length;</span><br><span class="line">	<span class="keyword">int8_t</span>    status_1;</span><br><span class="line">	<span class="keyword">int8_t</span>    status_2;</span><br><span class="line">	<span class="keyword">uint32_t</span>  misc;</span><br><span class="line">	<span class="keyword">uint32_t</span> _reserved;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>其中<code>addr</code>字段要填接收/发送缓存的物理地址。</p>
<p>EXP中很多网卡的设置步骤都遵循下面这个模式</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">outw(<span class="number">1</span>, PCNET_PORT + RAP);</span><br><span class="line">outw(lo, PCNET_PORT + RDP);</span><br></pre></td></tr></table></figure>

<p>第一个<code>outw</code>是用来设置RAP的值，然后第二个<code>outw</code>会将RAP的值作为索来设置CSR的值。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">s-&gt;csr[rap] = val;</span><br></pre></td></tr></table></figure>

<h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/io.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;err.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;inttypes.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;limits.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdbool.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PAGE_SHIFT      12</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PAGE_SIZE       (1 &lt;&lt; PAGE_SHIFT)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PFN_PRESENT     (1ull &lt;&lt; 63)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PFN_PFN         ((1ull &lt;&lt; 55) - 1)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> page_aligned __attribute__((aligned(PAGE_SIZE)))</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PCNET_BUFFER_SIZE 4096</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PCNET_PORT        0xc140</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DRX     0x0001</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DTX     0x0002</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LOOP    0x0004</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DXMTFCS 0x0008</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> INTL    0x0040</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DRCVPA  0x2000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DRCVBC  0x4000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PROM    0x8000</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">PCNET_registers</span> &#123;</span></span><br><span class="line">	RDP = <span class="number">0x10</span>,</span><br><span class="line">	RAP = <span class="number">0x12</span>,</span><br><span class="line">	RST = <span class="number">0x14</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CRC(crc, ch) (crc = (crc &gt;&gt; 8) ^ crctab[(crc ^ (ch)) &amp; 0xff])</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* generated using the AUTODIN II polynomial</span></span><br><span class="line"><span class="comment"> *	x^32 + x^26 + x^23 + x^22 + x^16 +</span></span><br><span class="line"><span class="comment"> *	x^12 + x^11 + x^10 + x^8 + x^7 + x^5 + x^4 + x^2 + x^1 + 1</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">uint32_t</span> crctab[<span class="number">256</span>] = &#123;</span><br><span class="line">	<span class="number">0x00000000</span>, <span class="number">0x77073096</span>, <span class="number">0xee0e612c</span>, <span class="number">0x990951ba</span>,</span><br><span class="line">	<span class="number">0x076dc419</span>, <span class="number">0x706af48f</span>, <span class="number">0xe963a535</span>, <span class="number">0x9e6495a3</span>,</span><br><span class="line">	<span class="number">0x0edb8832</span>, <span class="number">0x79dcb8a4</span>, <span class="number">0xe0d5e91e</span>, <span class="number">0x97d2d988</span>,</span><br><span class="line">	<span class="number">0x09b64c2b</span>, <span class="number">0x7eb17cbd</span>, <span class="number">0xe7b82d07</span>, <span class="number">0x90bf1d91</span>,</span><br><span class="line">	<span class="number">0x1db71064</span>, <span class="number">0x6ab020f2</span>, <span class="number">0xf3b97148</span>, <span class="number">0x84be41de</span>,</span><br><span class="line">	<span class="number">0x1adad47d</span>, <span class="number">0x6ddde4eb</span>, <span class="number">0xf4d4b551</span>, <span class="number">0x83d385c7</span>,</span><br><span class="line">	<span class="number">0x136c9856</span>, <span class="number">0x646ba8c0</span>, <span class="number">0xfd62f97a</span>, <span class="number">0x8a65c9ec</span>,</span><br><span class="line">	<span class="number">0x14015c4f</span>, <span class="number">0x63066cd9</span>, <span class="number">0xfa0f3d63</span>, <span class="number">0x8d080df5</span>,</span><br><span class="line">	<span class="number">0x3b6e20c8</span>, <span class="number">0x4c69105e</span>, <span class="number">0xd56041e4</span>, <span class="number">0xa2677172</span>,</span><br><span class="line">	<span class="number">0x3c03e4d1</span>, <span class="number">0x4b04d447</span>, <span class="number">0xd20d85fd</span>, <span class="number">0xa50ab56b</span>,</span><br><span class="line">	<span class="number">0x35b5a8fa</span>, <span class="number">0x42b2986c</span>, <span class="number">0xdbbbc9d6</span>, <span class="number">0xacbcf940</span>,</span><br><span class="line">	<span class="number">0x32d86ce3</span>, <span class="number">0x45df5c75</span>, <span class="number">0xdcd60dcf</span>, <span class="number">0xabd13d59</span>,</span><br><span class="line">	<span class="number">0x26d930ac</span>, <span class="number">0x51de003a</span>, <span class="number">0xc8d75180</span>, <span class="number">0xbfd06116</span>,</span><br><span class="line">	<span class="number">0x21b4f4b5</span>, <span class="number">0x56b3c423</span>, <span class="number">0xcfba9599</span>, <span class="number">0xb8bda50f</span>,</span><br><span class="line">	<span class="number">0x2802b89e</span>, <span class="number">0x5f058808</span>, <span class="number">0xc60cd9b2</span>, <span class="number">0xb10be924</span>,</span><br><span class="line">	<span class="number">0x2f6f7c87</span>, <span class="number">0x58684c11</span>, <span class="number">0xc1611dab</span>, <span class="number">0xb6662d3d</span>,</span><br><span class="line">	<span class="number">0x76dc4190</span>, <span class="number">0x01db7106</span>, <span class="number">0x98d220bc</span>, <span class="number">0xefd5102a</span>,</span><br><span class="line">	<span class="number">0x71b18589</span>, <span class="number">0x06b6b51f</span>, <span class="number">0x9fbfe4a5</span>, <span class="number">0xe8b8d433</span>,</span><br><span class="line">	<span class="number">0x7807c9a2</span>, <span class="number">0x0f00f934</span>, <span class="number">0x9609a88e</span>, <span class="number">0xe10e9818</span>,</span><br><span class="line">	<span class="number">0x7f6a0dbb</span>, <span class="number">0x086d3d2d</span>, <span class="number">0x91646c97</span>, <span class="number">0xe6635c01</span>,</span><br><span class="line">	<span class="number">0x6b6b51f4</span>, <span class="number">0x1c6c6162</span>, <span class="number">0x856530d8</span>, <span class="number">0xf262004e</span>,</span><br><span class="line">	<span class="number">0x6c0695ed</span>, <span class="number">0x1b01a57b</span>, <span class="number">0x8208f4c1</span>, <span class="number">0xf50fc457</span>,</span><br><span class="line">	<span class="number">0x65b0d9c6</span>, <span class="number">0x12b7e950</span>, <span class="number">0x8bbeb8ea</span>, <span class="number">0xfcb9887c</span>,</span><br><span class="line">	<span class="number">0x62dd1ddf</span>, <span class="number">0x15da2d49</span>, <span class="number">0x8cd37cf3</span>, <span class="number">0xfbd44c65</span>,</span><br><span class="line">	<span class="number">0x4db26158</span>, <span class="number">0x3ab551ce</span>, <span class="number">0xa3bc0074</span>, <span class="number">0xd4bb30e2</span>,</span><br><span class="line">	<span class="number">0x4adfa541</span>, <span class="number">0x3dd895d7</span>, <span class="number">0xa4d1c46d</span>, <span class="number">0xd3d6f4fb</span>,</span><br><span class="line">	<span class="number">0x4369e96a</span>, <span class="number">0x346ed9fc</span>, <span class="number">0xad678846</span>, <span class="number">0xda60b8d0</span>,</span><br><span class="line">	<span class="number">0x44042d73</span>, <span class="number">0x33031de5</span>, <span class="number">0xaa0a4c5f</span>, <span class="number">0xdd0d7cc9</span>,</span><br><span class="line">	<span class="number">0x5005713c</span>, <span class="number">0x270241aa</span>, <span class="number">0xbe0b1010</span>, <span class="number">0xc90c2086</span>,</span><br><span class="line">	<span class="number">0x5768b525</span>, <span class="number">0x206f85b3</span>, <span class="number">0xb966d409</span>, <span class="number">0xce61e49f</span>,</span><br><span class="line">	<span class="number">0x5edef90e</span>, <span class="number">0x29d9c998</span>, <span class="number">0xb0d09822</span>, <span class="number">0xc7d7a8b4</span>,</span><br><span class="line">	<span class="number">0x59b33d17</span>, <span class="number">0x2eb40d81</span>, <span class="number">0xb7bd5c3b</span>, <span class="number">0xc0ba6cad</span>,</span><br><span class="line">	<span class="number">0xedb88320</span>, <span class="number">0x9abfb3b6</span>, <span class="number">0x03b6e20c</span>, <span class="number">0x74b1d29a</span>,</span><br><span class="line">	<span class="number">0xead54739</span>, <span class="number">0x9dd277af</span>, <span class="number">0x04db2615</span>, <span class="number">0x73dc1683</span>,</span><br><span class="line">	<span class="number">0xe3630b12</span>, <span class="number">0x94643b84</span>, <span class="number">0x0d6d6a3e</span>, <span class="number">0x7a6a5aa8</span>,</span><br><span class="line">	<span class="number">0xe40ecf0b</span>, <span class="number">0x9309ff9d</span>, <span class="number">0x0a00ae27</span>, <span class="number">0x7d079eb1</span>,</span><br><span class="line">	<span class="number">0xf00f9344</span>, <span class="number">0x8708a3d2</span>, <span class="number">0x1e01f268</span>, <span class="number">0x6906c2fe</span>,</span><br><span class="line">	<span class="number">0xf762575d</span>, <span class="number">0x806567cb</span>, <span class="number">0x196c3671</span>, <span class="number">0x6e6b06e7</span>,</span><br><span class="line">	<span class="number">0xfed41b76</span>, <span class="number">0x89d32be0</span>, <span class="number">0x10da7a5a</span>, <span class="number">0x67dd4acc</span>,</span><br><span class="line">	<span class="number">0xf9b9df6f</span>, <span class="number">0x8ebeeff9</span>, <span class="number">0x17b7be43</span>, <span class="number">0x60b08ed5</span>,</span><br><span class="line">	<span class="number">0xd6d6a3e8</span>, <span class="number">0xa1d1937e</span>, <span class="number">0x38d8c2c4</span>, <span class="number">0x4fdff252</span>,</span><br><span class="line">	<span class="number">0xd1bb67f1</span>, <span class="number">0xa6bc5767</span>, <span class="number">0x3fb506dd</span>, <span class="number">0x48b2364b</span>,</span><br><span class="line">	<span class="number">0xd80d2bda</span>, <span class="number">0xaf0a1b4c</span>, <span class="number">0x36034af6</span>, <span class="number">0x41047a60</span>,</span><br><span class="line">	<span class="number">0xdf60efc3</span>, <span class="number">0xa867df55</span>, <span class="number">0x316e8eef</span>, <span class="number">0x4669be79</span>,</span><br><span class="line">	<span class="number">0xcb61b38c</span>, <span class="number">0xbc66831a</span>, <span class="number">0x256fd2a0</span>, <span class="number">0x5268e236</span>,</span><br><span class="line">	<span class="number">0xcc0c7795</span>, <span class="number">0xbb0b4703</span>, <span class="number">0x220216b9</span>, <span class="number">0x5505262f</span>,</span><br><span class="line">	<span class="number">0xc5ba3bbe</span>, <span class="number">0xb2bd0b28</span>, <span class="number">0x2bb45a92</span>, <span class="number">0x5cb36a04</span>,</span><br><span class="line">	<span class="number">0xc2d7ffa7</span>, <span class="number">0xb5d0cf31</span>, <span class="number">0x2cd99e8b</span>, <span class="number">0x5bdeae1d</span>,</span><br><span class="line">	<span class="number">0x9b64c2b0</span>, <span class="number">0xec63f226</span>, <span class="number">0x756aa39c</span>, <span class="number">0x026d930a</span>,</span><br><span class="line">	<span class="number">0x9c0906a9</span>, <span class="number">0xeb0e363f</span>, <span class="number">0x72076785</span>, <span class="number">0x05005713</span>,</span><br><span class="line">	<span class="number">0x95bf4a82</span>, <span class="number">0xe2b87a14</span>, <span class="number">0x7bb12bae</span>, <span class="number">0x0cb61b38</span>,</span><br><span class="line">	<span class="number">0x92d28e9b</span>, <span class="number">0xe5d5be0d</span>, <span class="number">0x7cdcefb7</span>, <span class="number">0x0bdbdf21</span>,</span><br><span class="line">	<span class="number">0x86d3d2d4</span>, <span class="number">0xf1d4e242</span>, <span class="number">0x68ddb3f8</span>, <span class="number">0x1fda836e</span>,</span><br><span class="line">	<span class="number">0x81be16cd</span>, <span class="number">0xf6b9265b</span>, <span class="number">0x6fb077e1</span>, <span class="number">0x18b74777</span>,</span><br><span class="line">	<span class="number">0x88085ae6</span>, <span class="number">0xff0f6a70</span>, <span class="number">0x66063bca</span>, <span class="number">0x11010b5c</span>,</span><br><span class="line">	<span class="number">0x8f659eff</span>, <span class="number">0xf862ae69</span>, <span class="number">0x616bffd3</span>, <span class="number">0x166ccf45</span>,</span><br><span class="line">	<span class="number">0xa00ae278</span>, <span class="number">0xd70dd2ee</span>, <span class="number">0x4e048354</span>, <span class="number">0x3903b3c2</span>,</span><br><span class="line">	<span class="number">0xa7672661</span>, <span class="number">0xd06016f7</span>, <span class="number">0x4969474d</span>, <span class="number">0x3e6e77db</span>,</span><br><span class="line">	<span class="number">0xaed16a4a</span>, <span class="number">0xd9d65adc</span>, <span class="number">0x40df0b66</span>, <span class="number">0x37d83bf0</span>,</span><br><span class="line">	<span class="number">0xa9bcae53</span>, <span class="number">0xdebb9ec5</span>, <span class="number">0x47b2cf7f</span>, <span class="number">0x30b5ffe9</span>,</span><br><span class="line">	<span class="number">0xbdbdf21c</span>, <span class="number">0xcabac28a</span>, <span class="number">0x53b39330</span>, <span class="number">0x24b4a3a6</span>,</span><br><span class="line">	<span class="number">0xbad03605</span>, <span class="number">0xcdd70693</span>, <span class="number">0x54de5729</span>, <span class="number">0x23d967bf</span>,</span><br><span class="line">	<span class="number">0xb3667a2e</span>, <span class="number">0xc4614ab8</span>, <span class="number">0x5d681b02</span>, <span class="number">0x2a6f2b94</span>,</span><br><span class="line">	<span class="number">0xb40bbe37</span>, <span class="number">0xc30c8ea1</span>, <span class="number">0x5a05df1b</span>, <span class="number">0x2d02ef8d</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pcnet_config</span> &#123;</span></span><br><span class="line">	<span class="keyword">uint16_t</span>  mode;</span><br><span class="line">	<span class="keyword">uint8_t</span>   rlen;</span><br><span class="line">	<span class="keyword">uint8_t</span>   tlen;</span><br><span class="line">	<span class="keyword">uint8_t</span>   mac[<span class="number">6</span>];</span><br><span class="line">	<span class="keyword">uint16_t</span> _reserved;</span><br><span class="line">	<span class="keyword">uint8_t</span>   ladr[<span class="number">8</span>];</span><br><span class="line">	<span class="keyword">uint32_t</span>  rx_desc;</span><br><span class="line">	<span class="keyword">uint32_t</span>  tx_desc;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pcnet_desc</span> &#123;</span></span><br><span class="line">	<span class="keyword">uint32_t</span>  addr;</span><br><span class="line">	<span class="keyword">int16_t</span>   length;</span><br><span class="line">	<span class="keyword">int8_t</span>    status_1;</span><br><span class="line">	<span class="keyword">int8_t</span>    status_2;</span><br><span class="line">	<span class="keyword">uint32_t</span>  misc;</span><br><span class="line">	<span class="keyword">uint32_t</span> _reserved;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">uint8_t</span> pcnet_packet[PCNET_BUFFER_SIZE] = &#123;</span><br><span class="line">	<span class="comment">//0x52, 0x54, 0x00, 0x12, 0x34, 0x56, 0x52,</span></span><br><span class="line">	<span class="comment">//0x54, 0x00, 0x12, 0x34, 0x56, 0x08, 0x00,</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> fd = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * taken from virtunoid.c</span></span><br><span class="line"><span class="comment"> * adress translation utilities</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">uint32_t</span> <span class="title">page_offset</span><span class="params">(<span class="keyword">uint32_t</span> addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> addr &amp; ((<span class="number">1</span> &lt;&lt; PAGE_SHIFT) - <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">uint64_t</span> <span class="title">gva_to_gfn</span><span class="params">(<span class="keyword">void</span> *addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">uint64_t</span> pme, gfn;</span><br><span class="line">	<span class="keyword">size_t</span> offset;</span><br><span class="line">	offset = ((<span class="keyword">uintptr_t</span>)addr &gt;&gt; <span class="number">9</span>) &amp; ~<span class="number">7</span>;</span><br><span class="line">	lseek(fd, offset, SEEK_SET);</span><br><span class="line">	read(fd, &amp;pme, <span class="number">8</span>);</span><br><span class="line">	<span class="keyword">if</span> (!(pme &amp; PFN_PRESENT))</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	gfn = pme &amp; PFN_PFN;</span><br><span class="line">	<span class="keyword">return</span> gfn;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">uint64_t</span> <span class="title">gva_to_gpa</span><span class="params">(<span class="keyword">void</span> *addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">uint64_t</span> gfn = gva_to_gfn(addr);</span><br><span class="line">	assert(gfn != <span class="number">-1</span>);</span><br><span class="line">	<span class="keyword">return</span> (gfn &lt;&lt; PAGE_SHIFT) | page_offset((<span class="keyword">uint64_t</span>)addr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* PCNET primitives */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">pcnet_packet_patch_crc</span><span class="params">(<span class="keyword">uint8_t</span> *packet, <span class="keyword">uint32_t</span> current,</span></span></span><br><span class="line"><span class="function"><span class="params">                            <span class="keyword">uint32_t</span> target)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">size_t</span> i = <span class="number">0</span>, j;</span><br><span class="line">	<span class="keyword">uint8_t</span> *ptr;</span><br><span class="line">	<span class="keyword">uint32_t</span> workspace[<span class="number">2</span>] = &#123; current, target &#125;;</span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i++)</span><br><span class="line">		workspace[i] &amp;= (<span class="keyword">uint32_t</span>)~<span class="number">0</span>;</span><br><span class="line">	ptr = (<span class="keyword">uint8_t</span> *)(workspace + <span class="number">1</span>);</span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) &#123;</span><br><span class="line">		j = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">while</span>(crctab[j] &gt;&gt; <span class="number">24</span> != *(ptr + <span class="number">3</span> - i)) j++;</span><br><span class="line">		*((<span class="keyword">uint32_t</span> *)(ptr - i)) ^= crctab[j];</span><br><span class="line">		*(ptr - i - <span class="number">1</span>) ^= j;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">strncpy</span>(packet, ptr - <span class="number">4</span>, <span class="number">4</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">uint64_t</span> <span class="title">pcnet_card_config</span><span class="params">(struct pcnet_config *config,</span></span></span><br><span class="line"><span class="function"><span class="params">                           struct pcnet_desc *rx_desc,</span></span></span><br><span class="line"><span class="function"><span class="params">                           struct pcnet_desc *tx_desc)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">memset</span>(config, <span class="number">0</span>, <span class="keyword">sizeof</span>(struct pcnet_config));</span><br><span class="line"></span><br><span class="line">	config-&gt;mode = LOOP | PROM;</span><br><span class="line">	<span class="built_in">strcpy</span>(config-&gt;mac, <span class="string">&quot;\xaa\xbb\xcc\xdd\xee\xff&quot;</span>);</span><br><span class="line">	config-&gt;rlen = <span class="number">0x0</span>;</span><br><span class="line">	config-&gt;tlen = <span class="number">0x0</span>;</span><br><span class="line">	config-&gt;rx_desc = (<span class="keyword">uint32_t</span>)gva_to_gpa(rx_desc);</span><br><span class="line">	config-&gt;tx_desc = (<span class="keyword">uint32_t</span>)gva_to_gpa(tx_desc);</span><br><span class="line">	<span class="keyword">return</span> gva_to_gpa(config);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">pcnet_desc_config</span><span class="params">(struct pcnet_desc *desc, <span class="keyword">void</span> *buffer, <span class="keyword">int</span> is_rx)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">uint16_t</span> bcnt = -PCNET_BUFFER_SIZE;</span><br><span class="line">	bcnt &amp;= <span class="number">0xfff</span>;</span><br><span class="line">	bcnt |= <span class="number">0xf000</span>;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">memset</span>(desc, <span class="number">0</span>, <span class="keyword">sizeof</span>(struct pcnet_desc));</span><br><span class="line">	<span class="built_in">memset</span>(buffer, <span class="number">0</span>, PCNET_BUFFER_SIZE);</span><br><span class="line">	desc-&gt;addr = (<span class="keyword">uint32_t</span>)gva_to_gpa(buffer);</span><br><span class="line">	desc-&gt;length = bcnt;</span><br><span class="line">	<span class="keyword">if</span> (is_rx) &#123;</span><br><span class="line">		<span class="comment">/* receive buffers owned by the card */</span></span><br><span class="line">		desc-&gt;status_2 = <span class="number">0x80</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">pcnet_packet_send</span><span class="params">(struct pcnet_desc *desc, <span class="keyword">void</span> *buffer,</span></span></span><br><span class="line"><span class="function"><span class="params">                       <span class="keyword">void</span> *packet, <span class="keyword">size_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (len &lt;= PCNET_BUFFER_SIZE) &#123;</span><br><span class="line">		<span class="built_in">memcpy</span>(buffer, packet, len);</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* set STP ENP ADDFCS bits */</span></span><br><span class="line">		desc-&gt;status_2 |= <span class="number">0x23</span>;</span><br><span class="line"></span><br><span class="line">		len = (-len);</span><br><span class="line">		len &amp;= <span class="number">0xfff</span>;</span><br><span class="line">		len |= <span class="number">0xf000</span>;</span><br><span class="line">		desc-&gt;length = len;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* flip ownership to card */</span></span><br><span class="line">		desc-&gt;status_2 |= <span class="number">0x80</span>;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* signal packet */</span></span><br><span class="line">		outw(<span class="number">0</span>, PCNET_PORT + RAP);</span><br><span class="line">		outw(<span class="number">0x8</span>, PCNET_PORT + RDP);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">pcnet_config</span> <span class="title">pcnet_config</span>;</span></span><br><span class="line">	<span class="keyword">uint32_t</span> pcnet_config_mem;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">pcnet_desc</span> <span class="title">pcnet_tx_desc</span> <span class="title">page_aligned</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">pcnet_desc</span> <span class="title">pcnet_rx_desc</span> <span class="title">page_aligned</span>;</span></span><br><span class="line">	<span class="keyword">void</span> *pcnet_rx_buffer, *pcnet_tx_buffer;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">void</span> *addr;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">uint32_t</span> fcs = ~<span class="number">0</span>;</span><br><span class="line">	<span class="keyword">uint8_t</span> *ptr;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">uint16_t</span> lo, hi;</span><br><span class="line"></span><br><span class="line">	fd = open(<span class="string">&quot;/proc/self/pagemap&quot;</span>, O_RDONLY);</span><br><span class="line">	<span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		perror(<span class="string">&quot;open&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	iopl(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">	addr = aligned_alloc(PAGE_SIZE, PCNET_BUFFER_SIZE);</span><br><span class="line">	pcnet_rx_buffer = (<span class="keyword">uint64_t</span> *)addr;</span><br><span class="line"></span><br><span class="line">	addr = aligned_alloc(PAGE_SIZE, PCNET_BUFFER_SIZE);</span><br><span class="line">	pcnet_tx_buffer = (<span class="keyword">uint64_t</span> *)addr;</span><br><span class="line"></span><br><span class="line">	pcnet_desc_config(&amp;pcnet_rx_desc, pcnet_rx_buffer, <span class="number">1</span>);</span><br><span class="line">	pcnet_desc_config(&amp;pcnet_tx_desc, pcnet_tx_buffer, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	pcnet_config_mem = (<span class="keyword">uint32_t</span>)pcnet_card_config(&amp;pcnet_config,</span><br><span class="line">	                                               &amp;pcnet_rx_desc,</span><br><span class="line">	                                               &amp;pcnet_tx_desc);</span><br><span class="line">	lo = (<span class="keyword">uint16_t</span>)pcnet_config_mem;</span><br><span class="line">	hi = pcnet_config_mem &gt;&gt; <span class="number">16</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* compute required crc */</span></span><br><span class="line">	ptr = pcnet_packet;</span><br><span class="line">	<span class="keyword">while</span> (ptr != &amp;pcnet_packet[PCNET_BUFFER_SIZE - <span class="number">4</span>])</span><br><span class="line">		CRC(fcs, *ptr++);</span><br><span class="line">	pcnet_packet_patch_crc(ptr, fcs, htonl(<span class="number">0xdeadbeef</span>));</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* soft reset */</span></span><br><span class="line">	inl(PCNET_PORT + <span class="number">0x18</span>);</span><br><span class="line">	inw(PCNET_PORT + RST);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* set swstyle */</span></span><br><span class="line">	outw(<span class="number">58</span>, PCNET_PORT + RAP);</span><br><span class="line">	outw(<span class="number">0x0102</span>, PCNET_PORT + RDP);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* card config */</span></span><br><span class="line">	outw(<span class="number">1</span>, PCNET_PORT + RAP);</span><br><span class="line">	outw(lo, PCNET_PORT + RDP);</span><br><span class="line">	outw(<span class="number">2</span>, PCNET_PORT + RAP);</span><br><span class="line">	outw(hi, PCNET_PORT + RDP);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* init and start */</span></span><br><span class="line">	outw(<span class="number">0</span>, PCNET_PORT + RAP);</span><br><span class="line">	outw(<span class="number">0x3</span>, PCNET_PORT + RDP);</span><br><span class="line"></span><br><span class="line">	sleep(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">	pcnet_packet_send(&amp;pcnet_tx_desc, pcnet_tx_buffer, pcnet_packet,</span><br><span class="line">	                  PCNET_BUFFER_SIZE);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>










    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2021/02/27/QEMU%E4%BF%A1%E6%81%AF%E6%B3%84%E6%BC%8F%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-CVE-2015-5165/" rel="prev" title="QEMU信息泄漏漏洞分析 CVE-2015-5165">
      <i class="fa fa-chevron-left"></i> QEMU信息泄漏漏洞分析 CVE-2015-5165
    </a></div>
      <div class="post-nav-item">
    <a href="/2021/03/16/AFL%E5%AE%89%E8%A3%85%E4%B8%8E%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/" rel="next" title="AFL安装与简单使用">
      AFL安装与简单使用 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="nav-number">1.</span> <span class="nav-text">环境搭建</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="nav-number">2.</span> <span class="nav-text">漏洞分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="nav-number">3.</span> <span class="nav-text">漏洞利用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E8%A7%A6%E5%8F%91%E8%B7%AF%E5%BE%84"><span class="nav-number">3.1.</span> <span class="nav-text">漏洞触发路径</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CRC%E9%80%86%E5%90%91"><span class="nav-number">3.2.</span> <span class="nav-text">CRC逆向</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9B%B8%E5%85%B3%E9%85%8D%E7%BD%AE"><span class="nav-number">3.3.</span> <span class="nav-text">相关配置</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#EXP"><span class="nav-number">4.</span> <span class="nav-text">EXP</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">coco</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">5</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">分类</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">1</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">coco</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  
      

<script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      loader: {
        source: {
          '[tex]/amsCd': '[tex]/amscd',
          '[tex]/AMScd': '[tex]/amscd'
        }
      },
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              let target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    (function () {
      var script = document.createElement('script');
      script.src = '//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
      script.defer = true;
      document.head.appendChild(script);
    })();
  } else {
    MathJax.startup.document.state(0);
    MathJax.texReset();
    MathJax.typeset();
  }
</script>

    

  

</body>
</html>
